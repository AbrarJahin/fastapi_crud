.PHONY: install dev clean update-db update-env run clear

ENV_NAME := fastapi-sqlite-crud
ENV_FILE := environment.yml
HOST := 127.0.0.1
PORT := 8000

CONDA := conda
RUN := $(CONDA) run -n $(ENV_NAME)

clear:
	@python -c "print('\033c', end='')"

# install:
# - if env doesn't exist -> create it from environment.yml
# - else -> update it
# - then run migrations
install: clear
	@echo make install
	@python -c "import json,subprocess,os,sys; \
env='$(ENV_NAME)'; yml='$(ENV_FILE)'; \
p=subprocess.run(['conda','env','list','--json'], capture_output=True, text=True); \
data=json.loads(p.stdout) if p.returncode==0 and p.stdout else {'envs':[]}; \
names=[os.path.basename(e) for e in data.get('envs',[])]; \
cmd=(['conda','env','create','-n',env,'-f',yml] if env not in names else ['conda','env','update','-n',env,'-f',yml,'--prune']); \
print('Running:', ' '.join(cmd)); \
sys.exit(subprocess.call(cmd))"
	$(RUN) alembic upgrade head

# dev mode with reload + logging to ./log/<timestamp>.log
dev:
	$(RUN) python -c "import os,subprocess,datetime; \
os.makedirs('log', exist_ok=True); \
ts=datetime.datetime.now().strftime('%Y%m%d_%H%M%S'); \
log=f'log/{ts}.log'; \
f=open(log,'w', encoding='utf-8'); \
p=subprocess.Popen(['uvicorn','app.main:app','--reload','--host','$(HOST)','--port','$(PORT)'], stdout=f, stderr=subprocess.STDOUT); \
p.wait()"

# If you want dev WITHOUT writing logs to file, use this instead:
dev-nolog:
	$(RUN) uvicorn app.main:app --reload --host $(HOST) --port $(PORT)

# run mode (no reload)
# (this target is useful if you want a production-like run)
run:
	@python -c "import json,subprocess,os,sys; \
env='$(ENV_NAME)'; \
p=subprocess.run(['conda','env','list','--json'], capture_output=True, text=True); \
data=json.loads(p.stdout) if p.returncode==0 and p.stdout else {'envs':[]}; \
names=[os.path.basename(e) for e in data.get('envs',[])]; \
mk=os.environ.get('MAKE','make'); \
sys.exit(subprocess.call([mk,'install']) if env not in names else 0)"
	$(RUN) uvicorn app.main:app --host $(HOST) --port $(PORT)

# Clean: remove DB + remove env (safe order)
clean: clear
	@echo make clean
	@python -c "import os; p='app.db'; os.remove(p) if os.path.exists(p) else None"
	$(CONDA) env remove -n $(ENV_NAME) -y || true

# Create and apply an autogenerated migration + upgrade
update-db:
	$(RUN) python -c "from datetime import datetime; import subprocess; \
msg='auto-'+datetime.now().strftime('%Y%m%d-%H%M%S'); \
subprocess.check_call(['alembic','revision','--autogenerate','-m',msg])"
	$(RUN) alembic upgrade head

# Recreate env from scratch
update-env:
	$(CONDA) env remove -n $(ENV_NAME) -y || true
	$(CONDA) env create -n $(ENV_NAME) -f $(ENV_FILE)
